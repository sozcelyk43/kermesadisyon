<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMET LEZZET GÜNLERİ ADİSYON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal { 
            display: none; 
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex; 
        }
        #orderPageContainer, #quickSaleModal { 
            display: none; 
        }
        #orderPageContainer.active, #quickSaleModal.active {
            display: block; 
        }
        #quickSaleModal.active { 
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            align-items: center;
            justify-content: center;
            z-index: 50; 
            padding: 1rem;
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #loadingOverlay {
            display: none; 
        }
        #loadingOverlay.active {
            display: flex;
        }
        /* Ürün Kartı Miktarı */
        .product-card-quantity input {
            width: 40px; 
            text-align: center;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            padding-top: 0.1rem;
            padding-bottom: 0.1rem;
        }
         .product-card-quantity button {
             min-width: 24px; 
             height: 24px; 
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

        /* Kategori Alanı Renkleri */
        .category-section-bg-ET-TAVUK { background-color: #fee2e2; } /* red-100 */
        .category-section-bg-ATIŞTIRMALIK { background-color: #ffedd5; } /* orange-100 */
        .category-section-bg-TATLI { background-color: #fce7f3; } /* pink-100 */
        .category-section-bg-İÇECEK { background-color: #eff6ff; } /* blue-100 */
        .category-section-bg-ÇORBA { background-color: #fef9c3; } /* yellow-100 */
        .category-section-bg-DİĞER { background-color: #dcfce7; } /* green-100 */
        .category-section-bg-default { background-color: #f3f4f6; } /* gray-100 */

        /* Ürün Kartı Renkleri (Kategorinin daha koyu tonu) */
        .product-card-bg-ET-TAVUK { background-color: #fecaca; } /* red-200 */
        .product-card-bg-ATIŞTIRMALIK { background-color: #fed7aa; } /* orange-200 */
        .product-card-bg-TATLI { background-color: #fbcfe8; } /* pink-200 */
        .product-card-bg-İÇECEK { background-color: #dbeafe; } /* blue-200 */
        .product-card-bg-ÇORBA { background-color: #fef08a; } /* yellow-200 */
        .product-card-bg-DİĞER { background-color: #bbf7d0; } /* green-200 */
        .product-card-bg-default { background-color: #e5e7eb; } /* gray-200 */


        /* Ürün Kartı Görünümü */
        .product-card {
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
            padding: 0.75rem; 
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            min-height: 120px; 
        }
         .product-card.quick-sale-card { 
            min-height: 110px; 
            padding: 0.5rem;
        }
        .product-card:hover {
            transform: translateY(-2px); 
        }
        .product-card h5 { 
             font-weight: 600; 
             color: #1f2937; 
             margin-bottom: 0.25rem;
             font-size: 0.875rem; 
        }
         .product-card.quick-sale-card h5 { 
             font-size: 0.8rem; 
             text-align: center;
             margin-bottom: 0.3rem;
             line-height: 1.2; 
             min-height: 2.4em; 
             display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
         }
         .product-card p.product-price { 
             color: #4b5563; 
             font-size: 0.8rem;
             margin-bottom: 0.5rem;
         }
         .product-card .description-input {
             margin-top: 0.5rem;
             margin-bottom: 0.5rem;
             background-color: #fff; 
         }
         .product-card .add-item-from-card-btn {
             margin-top: auto; 
         }
         .product-card.quick-sale-card .add-item-from-card-btn {
             padding-top: 0.5rem;
             padding-bottom: 0.5rem;
             font-size: 0.875rem; 
         }


        /* Yazdırma stilleri */
        @media print {
            body * {
                visibility: hidden;
            }
            /* Fiş yazdırma */
            #receiptModalContent, #receiptModalContent * {
                visibility: visible;
            }
            #receiptModalContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100mm; 
                font-size: 9pt; 
                padding: 4mm; 
                box-sizing: border-box;
                border: 1px solid #ccc; 
            }
             /* Satış Raporu yazdırma (A4 dikey) */
            #salesReportModalContent, #salesReportModalContent * {
                 visibility: visible;
            }
             #salesReportModalContent {
                 position: absolute;
                 left: 0;
                 top: 0;
                 width: 100%; 
                 font-size: 10pt;
                 padding: 10mm;
                 box-sizing: border-box;
             }
             #salesReportModalContent table {
                 width: 100%;
                 border-collapse: collapse;
             }
             #salesReportModalContent th, #salesReportModalContent td {
                 border: 1px solid #ccc;
                 padding: 2mm;
                 text-align: left;
             }
             #salesReportModalContent th {
                 background-color: #eee;
             }

            /* Genel yazdırma gizlemeleri */
            #receiptModalContent button, 
            #salesReportModalContent button,
            #quickSaleModal button:not(#printReceiptButton), 
            #appContainer button,
            #orderPageContainer button:not(#printReceiptButton):not(#closeReceiptModalButton) 
             {
                display: none !important; 
            }
             #appContainer header, #orderPageContainer header, #quickSaleModal header {
                 display: none !important;
             }

            #receiptModalContent h2 { 
                font-size: 11pt;
                font-weight: bold;
                margin-bottom: 3mm;
                text-align: center;
            }
             #receiptModalContent p, #receiptModalContent div#receiptItems > div {
                line-height: 1.3;
                margin-bottom: 1mm;
            }
            #receiptModalContent div#receiptItems > div { 
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap; 
            }
             #receiptModalContent div#receiptItems span.item-details {
                flex-basis: 70%; 
             }
             #receiptModalContent div#receiptItems span.item-price {
                 flex-basis: 30%; 
                 text-align: right;
             }
            #receiptModalContent div#receiptItems span.item-description,
            #receiptModalContent div#receiptItems span.item-waiter { 
                display: block;
                font-size: 7pt;
                padding-left: 5mm;
                color: #555;
                flex-basis: 100%; 
            }
            #receiptModalContent hr {
                margin-top: 2mm;
                margin-bottom: 2mm;
                border-top: 1px dashed #999;
            }
            #receiptModalContent .text-right p#receiptTotalLine { 
                font-size: 10pt;
                font-weight: bold;
            }
            #receiptModalContent p.thank-you-note { 
                 margin-top: 4mm;
                 text-align: center;
                 font-size: 8pt;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loadingOverlay" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loadingMessage" class="text-lg font-medium text-gray-700">Bağlanılıyor...</p>
        </div>
    </div>

    <div id="loginModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 active">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-600">Kullanıcı Girişi</h2>
            <p class="text-sm text-gray-500 text-center mb-4">Garson veya Kasa olarak giriş yapın.</p>
            <input type="text" id="usernameInput" placeholder="Kullanıcı Adı" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="password" id="passwordInput" placeholder="Şifre" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-md transition duration-150">Giriş Yap</button>
            <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-blue-700">EMET LEZZET GÜNLERİ ADİSYON</h1>
                <p class="text-gray-600 mt-1">Aktif Kullanıcı: <span id="activeUserName" class="font-semibold"></span> (<span id="activeUserRole" class="capitalize"></span>)</p>
            </div>
            <div class="flex gap-2">
                <button id="quickSaleEntryButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Hızlı Satış</button>
                <button id="salesReportButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 hidden">Satış Raporu</button>
                <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Çıkış Yap</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <main class="md:col-span-2">
                <section id="tablesSection" class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Masalar</h2>
                    <div id="tablesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        </div>
                </section>
            </main>
            <aside class="md:col-span-1">
                <section id="productsReferenceSection" class="mb-8">
                     <h2 class="text-2xl font-semibold mb-4 text-gray-700">Güncel Menü</h2>
                     <div class="bg-white p-6 rounded-lg shadow max-h-[70vh] overflow-y-auto">
                        <div id="productsListRef">
                            </div>
                     </div>
                </section>
            </aside>
        </div>
    </div>

    <div id="orderPageContainer" class="container mx-auto p-4 md:p-8"> 
        <header class="mb-6 flex flex-wrap justify-between items-center">
            <div class="w-full md:w-auto mb-2 md:mb-0">
                <h2 class="text-3xl font-semibold text-blue-700">Sipariş: <span id="orderPageTableName"></span></h2>
                <p id="orderPageWaiterInfo" class="text-sm text-gray-600 mt-1">Bu Masaya Henüz Sipariş Alınmadı</p>
            </div>
            <button id="backToTablesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Masalara Dön</button>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> 
            <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow"> 
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Ürün Seçimi</h3>
                <div id="orderPageProductGrid" class="space-y-6 max-h-[75vh] overflow-y-auto pr-2">
                    </div>

                <div id="manualProductSection" class="mt-6 pt-6 border-t border-gray-200 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-orange-600">Manuel Ürün Ekle (Sadece Kasa)</h3>
                    <div class="space-y-3">
                        <input type="text" id="manualProductName" placeholder="Ürün Adı" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                         <div>
                            <label for="manualProductCategory" class="block text-sm font-medium text-gray-600 mb-1">Kategori:</label>
                            <select id="manualProductCategory" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                                <option value="">Kategori Seçin</option>
                            </select>
                        </div>
                        <input type="number" id="manualProductPrice" placeholder="Fiyat (₺)" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        <input type="number" id="manualProductQuantity" placeholder="Adet" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        <input type="text" id="manualProductDescription" placeholder="Açıklama (isteğe bağlı)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500">
                        <button id="addManualProductButton" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold p-2 rounded-md transition duration-150">Manuel Ürünü Ekle</button>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-1 bg-white p-6 rounded-lg shadow"> 
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Mevcut Sipariş</h3>
                <div id="orderPageCurrentOrderItems" class="space-y-3 max-h-[75vh] overflow-y-auto pr-2">
                    </div>
                <div id="orderPageCurrentOrderTotal" class="text-right font-bold text-2xl mt-6 text-gray-800">
                    Toplam: 0 ₺
                </div>
                <button id="orderPageCompleteOrderButton" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-md transition duration-150 hidden">Siparişi Tamamla ve Fiş Yazdır</button>
            </section>
        </div>
    </div>

    <div id="quickSaleModal" class="modal">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col">
            <header class="mb-4 flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-green-700">Hızlı Satış</h2>
                <button id="closeQuickSaleModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow overflow-hidden">
                <section class="md:col-span-2 bg-gray-50 p-3 rounded-lg shadow-inner overflow-y-auto max-h-[calc(95vh-150px)]">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Ürün Seçimi</h3>
                    <div id="quickSaleProductGrid" class="space-y-4">
                        </div>
                </section>
                <section class="md:col-span-1 bg-gray-50 p-3 rounded-lg shadow-inner flex flex-col max-h-[calc(95vh-150px)]">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Hızlı Satış Sepeti</h3>
                    <div id="quickSaleCurrentItems" class="space-y-2 flex-grow overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">Sepet boş.</p>
                    </div>
                    <div id="quickSaleTotal" class="text-right font-bold text-xl mt-4 pt-2 border-t">
                        Toplam: 0 ₺
                    </div>
                    <button id="completeQuickSaleButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold p-3 rounded-md transition duration-150">Satışı Tamamla ve Fiş Kes</button>
                </section>
            </div>
        </div>
    </div>


    <div id="receiptModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div id="receiptModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="flex-grow overflow-y-auto">
                <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">EMET LEZZET GÜNLERİ</h2>
                <p class="text-center text-sm text-gray-600 mb-1">Fiş/Adisyon</p>
                <p class="text-center text-sm text-gray-600 mb-4">Tarih: <span id="receiptDate"></span></p>
                <div class="mb-2">
                    <p class="text-sm"><span class="font-semibold">Masa:</span> <span id="receiptTableName"></span></p>
                    <p class="text-sm"><span class="font-semibold">Garson/Kasa:</span> <span id="receiptWaiterName">Bilinmiyor</span></p> 
                </div>
                <hr class="my-2 border-gray-300">
                <div id="receiptItems" class="text-sm space-y-1 mb-2">
                    </div>
                <hr class="my-2 border-dashed border-gray-400">
                <div class="text-right">
                    <p id="receiptTotalLine" class="text-lg font-bold text-gray-800">TOPLAM: <span id="receiptTotal"></span> ₺</p>
                </div>
                <p class="thank-you-note text-center text-xs text-gray-500 mt-6">Teşekkür Ederiz!</p>
            </div>
            <div class="mt-auto pt-4 flex space-x-2">
                <button id="printReceiptButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Yazdır</button>
                <button id="closeReceiptModalButton" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-3 rounded-md transition duration-150">Kapat</button>
            </div>
        </div>
    </div>

    <div id="salesReportModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div id="salesReportModalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-semibold text-teal-700">Satış Raporu</h2>
                 <button id="closeSalesReportModalButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto mb-4">
                <div id="salesReportTableContainer">
                    <p class="text-center text-gray-500">Rapor yükleniyor veya hiç satış yok...</p>
                    </div>
                <div id="salesReportSummary" class="mt-4 pt-4 border-t text-right">
                     <p class="font-semibold">Toplam Satış Adedi: <span id="totalItemsSold">0</span></p>
                     <p class="font-bold text-xl">Genel Toplam: <span id="grandTotalSales">0 ₺</span></p>
                </div>
            </div>
             <div class="mt-auto pt-4 flex space-x-2">
                <button id="refreshSalesReportButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-md transition duration-150">Yenile</button>
                <button id="printSalesReportButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-md transition duration-150">Raporu Yazdır</button>
            </div>
        </div>
    </div>


<script>
    // *** YEREL TEST İÇİN URL ***
    // Render'a yüklerken burayı 'wss://<UYGULAMA_ADINIZ>.onrender.com' olarak değiştirin.
    const WEBSOCKET_URL = 'wss://emet-adisyon.onrender.com'; 
    let socket;

    const appState = {
        user: null, 
        // GÜNCELLENMİŞ ÜRÜN LİSTESİ
        products: [ 
            // ET - TAVUK Kategorisi (ID'ler 1000'den başlasın)
            { id: 1001, name: "TAVUK (PİLİÇ) ÇEVİRME KG", price: 250.00, category: "ET - TAVUK" },
            { id: 1002, name: "ET DÖNER PORSİYON (100 GRAM)", price: 185.00, category: "ET - TAVUK" },
            { id: 1003, name: "YAPRAK DÖNER PORSİYON (100 GRAM)", price: 150.00, category: "ET - TAVUK" },
            { id: 1004, name: "TAVUK DÖNER PORSİYON (100gr)", price: 150.00, category: "ET - TAVUK" },
            { id: 1005, name: "KÖFTE PORSİYON (120 gr 6 adet) SERVİSLİ", price: 150.00, category: "ET - TAVUK" },
            { id: 1006, name: "ET İSKENDER (110 gr)", price: 275.00, category: "ET - TAVUK" },
            { id: 1007, name: "TAVUK İSKENDER (110 gr)", price: 200.00, category: "ET - TAVUK" },
            { id: 1008, name: "ET DÖNER - KG", price: 1300.00, category: "ET - TAVUK" },
            { id: 1009, name: "ET DÖNER - 500 GR", price: 650.00, category: "ET - TAVUK" },
            { id: 1010, name: "TAVUK DÖNER - KG", price: 800.00, category: "ET - TAVUK" },
            { id: 1011, name: "TAVUK DÖNER - 500 GR", price: 400.00, category: "ET - TAVUK" },
            { id: 1012, name: "KUZU ŞİŞ (100 gr.) SERVİSLİ", price: 150.00, category: "ET - TAVUK" },
            { id: 1013, name: "ADANA ŞİŞ (100 gr.)", price: 150.00, category: "ET - TAVUK" },
            { id: 1014, name: "PİRZOLA - 4 ADET", price: 250.00, category: "ET - TAVUK" },
            { id: 1015, name: "TAVUK FAJİTA", price: 200.00, category: "ET - TAVUK" },
            { id: 1016, name: "ÇITIR PİRZOLA (KELEBEK) KG PİŞMİŞ SERVİSLİ", price: 350.00, category: "ET - TAVUK" },
            { id: 1017, name: "KANAT IZGARA KG PİŞMİŞ SERVİSLİ", price: 550.00, category: "ET - TAVUK" },
            { id: 1018, name: "TAVUK PİRZOLA KG PİŞMİŞ SERVİSLİ", price: 530.00, category: "ET - TAVUK" },
            { id: 1019, name: "CİĞER ŞİŞ (100 gr.) SERVİSLİ", price: 80.00, category: "ET - TAVUK" },
            { id: 1020, name: "TAVUK ŞİŞ (100 gr.) SERVİSLİ", price: 90.00, category: "ET - TAVUK" },

            // ATIŞTIRMALIK Kategorisi (ID'ler 2000'den başlasın)
            { id: 2001, name: "EKMEK ARASI ET DÖNER (80 GR)", price: 160.00, category: "ATIŞTIRMALIK" },
            { id: 2002, name: "EKMEK ARASI KÖFTE (100 gr 5 adet)", price: 130.00, category: "ATIŞTIRMALIK" },
            { id: 2003, name: "TAVUK DÖNER EKMEK ARASI (80 gr)", price: 130.00, category: "ATIŞTIRMALIK" },
            { id: 2004, name: "PİZZA KARIŞIK (ORTA BOY)", price: 150.00, category: "ATIŞTIRMALIK" },
            { id: 2005, name: "PİZZA KARIŞIK (BÜYÜK BOY)", price: 200.00, category: "ATIŞTIRMALIK" },
            { id: 2006, name: "LAHMACUN", price: 75.00, category: "ATIŞTIRMALIK" },
            { id: 2007, name: "PİDE ÇEŞİTLERİ", price: 100.00, category: "ATIŞTIRMALIK" },
            { id: 2008, name: "AYVALIK TOSTU", price: 100.00, category: "ATIŞTIRMALIK" },
            { id: 2009, name: "HAMBURGER", price: 120.00, category: "ATIŞTIRMALIK" },
            { id: 2010, name: "ÇİĞ KÖFTE KG (MARUL-LİMON)", price: 300.00, category: "ATIŞTIRMALIK" },
            { id: 2011, name: "KUMRU", price: 80.00, category: "ATIŞTIRMALIK" }, // Eski menüden eklendi

            // İÇECEK Kategorisi (ID'ler 3000'den başlasın)
            { id: 3001, name: "OSMANLI ŞERBETİ - 1 LİTRE", price: 75.00, category: "İÇECEK" },
            { id: 3002, name: "LİMONATA", price: 75.00, category: "İÇECEK" },
            { id: 3003, name: "SU", price: 10.00, category: "İÇECEK" },
            { id: 3004, name: "AYRAN", price: 15.00, category: "İÇECEK" },
            { id: 3005, name: "ÇAY", price: 10.00, category: "İÇECEK" },
            { id: 3006, name: "GAZOZ", price: 25.00, category: "İÇECEK" },
            { id: 3007, name: "SADE MADEN SUYU", price: 10.00, category: "İÇECEK" },
            { id: 3008, name: "MEYVELİ MADEN SUYU", price: 15.00, category: "İÇECEK" },
            { id: 3009, name: "KUTU İÇECEKLER", price: 30.00, category: "İÇECEK" }, // Eski menüden

            // TATLI Kategorisi (ID'ler 4000'den başlasın)
            { id: 4001, name: "EV BAKLAVASI - KG", price: 400.00, category: "TATLI" },
            { id: 4002, name: "EV BAKLAVASI - 500 GRAM", price: 200.00, category: "TATLI" },
            { id: 4003, name: "EV BAKLAVASI - PORSİYON", price: 75.00, category: "TATLI" },
            { id: 4004, name: "AŞURE - 500 GRAM", price: 100.00, category: "TATLI" },
            { id: 4005, name: "HÖŞMERİM - 500 GRAM", price: 100.00, category: "TATLI" },
            { id: 4006, name: "DİĞER PASTA ÇEŞİTLERİ", price: 50.00, category: "TATLI" },
            { id: 4007, name: "YAĞLI GÖZLEME", price: 50.00, category: "TATLI" },
            { id: 4008, name: "İÇLİ GÖZLEME", price: 60.00, category: "TATLI" },
            { id: 4009, name: "TRİLEÇE DİLİM", price: 70.00, category: "TATLI" },
            { id: 4010, name: "KABAK TATLISI KG.", price: 90.00, category: "TATLI" },
            { id: 4011, name: "AŞURE - KG", price: 125.00, category: "TATLI" }, // Eski menüden
            { id: 4012, name: "HÖŞMERİM - KG", price: 110.00, category: "TATLI" }, // Eski menüden

            // ÇORBA Kategorisi (ID'ler 5000'den başlasın)
            { id: 5001, name: "KELLE PAÇA ÇORBA", price: 60.00, category: "ÇORBA" },
            { id: 5002, name: "TARHANA ÇORBA", price: 60.00, category: "ÇORBA" },
            
            // DİĞER Kategorisi (ID'ler 6000'den başlasın)
            { id: 6001, name: "PİŞMEMİŞ KASAP KÖFTE", price: 620.00, category: "DİĞER" },
            { id: 6002, name: "PİŞMEMİŞ İNEGÖL KÖFTE", price: 620.00, category: "DİĞER" },
            { id: 6003, name: "BÜYÜKBAŞ DANA KIYMA KG", price: 650.00, category: "DİĞER" },
            { id: 6004, name: "BÜYÜKBAŞ DANA KUŞBAŞI", price: 680.00, category: "DİĞER" },
            { id: 6005, name: "MANTI (KIYMALI)", price: 150.00, category: "DİĞER" },
            { id: 6006, name: "MANTI (MERCİMEKLİ)", price: 100.00, category: "DİĞER" },
            { id: 6007, name: "SARMA (ZEYTİNYAĞLI) KG.", price: 270.00, category: "DİĞER" }
        ],
        tables: [], 
        currentTableId: null, 
        salesReport: [],
        currentQuickSaleOrder: [] 
    };

    // --- DOM Elementleri ---
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loginModal = document.getElementById('loginModal');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    const appContainer = document.getElementById('appContainer');
    const activeUserNameSpan = document.getElementById('activeUserName'); 
    const activeUserRoleSpan = document.getElementById('activeUserRole'); 
    const logoutButton = document.getElementById('logoutButton');
    const salesReportButton = document.getElementById('salesReportButton'); 
    const quickSaleEntryButton = document.getElementById('quickSaleEntryButton'); 
    const tablesGrid = document.getElementById('tablesGrid');
    const productsListRef = document.getElementById('productsListRef');
    
    const orderPageContainer = document.getElementById('orderPageContainer');
    const orderPageTableName = document.getElementById('orderPageTableName');
    const orderPageWaiterInfo = document.getElementById('orderPageWaiterInfo'); 
    const backToTablesButton = document.getElementById('backToTablesButton');
    const orderPageProductGrid = document.getElementById('orderPageProductGrid'); 
    const orderPageCurrentOrderItems = document.getElementById('orderPageCurrentOrderItems');
    const orderPageCurrentOrderTotal = document.getElementById('orderPageCurrentOrderTotal');
    const orderPageCompleteOrderButton = document.getElementById('orderPageCompleteOrderButton');

    const manualProductSection = document.getElementById('manualProductSection');
    const manualProductName = document.getElementById('manualProductName');
    const manualProductCategory = document.getElementById('manualProductCategory'); 
    const manualProductPrice = document.getElementById('manualProductPrice');
    const manualProductQuantity = document.getElementById('manualProductQuantity');
    const manualProductDescription = document.getElementById('manualProductDescription');
    const addManualProductButton = document.getElementById('addManualProductButton');

    // Hızlı Satış Modalı Elementleri
    const quickSaleModal = document.getElementById('quickSaleModal');
    const closeQuickSaleModalButton = document.getElementById('closeQuickSaleModalButton');
    const quickSaleProductGrid = document.getElementById('quickSaleProductGrid');
    const quickSaleCurrentItems = document.getElementById('quickSaleCurrentItems');
    const quickSaleTotal = document.getElementById('quickSaleTotal');
    const completeQuickSaleButton = document.getElementById('completeQuickSaleButton');


    const receiptModal = document.getElementById('receiptModal');
    const receiptDate = document.getElementById('receiptDate');
    const receiptTableName = document.getElementById('receiptTableName');
    const receiptWaiterName = document.getElementById('receiptWaiterName');
    const receiptItems = document.getElementById('receiptItems');
    const receiptTotal = document.getElementById('receiptTotal');
    const printReceiptButton = document.getElementById('printReceiptButton');
    const closeReceiptModalButton = document.getElementById('closeReceiptModalButton');

    const salesReportModal = document.getElementById('salesReportModal');
    const salesReportModalContent = document.getElementById('salesReportModalContent'); 
    const closeSalesReportModalButton = document.getElementById('closeSalesReportModalButton');
    const salesReportTableContainer = document.getElementById('salesReportTableContainer');
    const totalItemsSoldSpan = document.getElementById('totalItemsSold');
    const grandTotalSalesSpan = document.getElementById('grandTotalSales');
    const refreshSalesReportButton = document.getElementById('refreshSalesReportButton');
    const printSalesReportButton = document.getElementById('printSalesReportButton');


    // --- Yardımcı Fonksiyonlar ---
    function formatPrice(price) {
        if (typeof price !== 'number' || isNaN(price)) {
            return '0 ₺'; 
        }
        const formatted = price.toFixed(2).replace('.', ',');
        if (formatted.endsWith(',00')) {
            return formatted.substring(0, formatted.length - 3) + ' ₺';
        }
        return formatted + ' ₺';
    }


    // Timestamp'i okunabilir tarih/saat formatına çevirir
    function formatTimestamp(timestamp) {
        if (!timestamp) return '-';
        try {
            const date = new Date(timestamp);
             if (isNaN(date.getTime())) return '-'; 
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        } catch (e) {
            console.error("Timestamp formatlama hatası:", e);
            return '-';
        }
    }


    function getCurrentFormattedDate() {
        const now = new Date();
        return `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function showLoading(message = "İşleniyor...") {
        loadingMessage.textContent = message;
        loadingOverlay.classList.add('active');
    }

    function hideLoading() {
        loadingOverlay.classList.remove('active');
    }

    // Kategori adı için CSS sınıfı üreten fonksiyon
    function sanitizeCategoryForCSS(categoryName) {
        if (!categoryName) return 'default';
        const turkishMap = { 'İ': 'I', 'ı': 'i', 'Ö': 'O', 'ö': 'o', 'Ü': 'U', 'ü': 'u', 'Ş': 'S', 'ş': 's', 'Ğ': 'G', 'ğ': 'g', 'Ç': 'C', 'ç': 'c' };
        return categoryName
            .replace(/[İıÖöÜüŞşĞğÇç]/g, match => turkishMap[match] || match) 
            .replace(/&/g, 'AND') 
            .replace(/\s+/g, '-') 
            .replace(/[^a-zA-Z0-9-]/g, '') 
            .toUpperCase(); 
    }


    // --- WebSocket Fonksiyonları ---
    function connectWebSocket() {
        showLoading("Sunucuya bağlanılıyor...");
        socket = new WebSocket(WEBSOCKET_URL);

        socket.onopen = () => {
            console.log("WebSocket bağlantısı kuruldu.");
            hideLoading();
            // Oturum kontrolü
            const storedUser = localStorage.getItem('adisyonUser');
            if (storedUser) {
                try {
                    appState.user = JSON.parse(storedUser);
                    console.log("Oturum bulundu:", appState.user.username);
                    activeUserNameSpan.textContent = appState.user.username;
                    activeUserRoleSpan.textContent = appState.user.role;
                    loginModal.classList.remove('active');
                    appContainer.classList.remove('hidden'); 
                    orderPageContainer.classList.remove('active');
                    updateUIForRole();
                    // Oturum sürdürme mesajı gönder
                    sendMessageToServer('reauthenticate', { user: appState.user }); 
                } catch (e) {
                    console.error("localStorage'dan kullanıcı verisi okunamadı:", e);
                    localStorage.removeItem('adisyonUser'); 
                    loginModal.classList.add('active'); 
                    appContainer.classList.add('hidden');
                    orderPageContainer.classList.remove('active');
                }
            } else {
                loginModal.classList.add('active'); 
                appContainer.classList.add('hidden');
                orderPageContainer.classList.remove('active');
            }
        };

        socket.onmessage = (event) => {
            console.log("RAW Sunucudan mesaj alındı:", event.data); 
            let message;
            try {
                message = JSON.parse(event.data);
            } catch (error) {
                console.error("JSON.parse BAŞARISIZ!", "Hata:", error, "Alınan Veri:", event.data);
                return; 
            }
            handleServerMessage(message);
        };

        socket.onerror = (error) => {
            console.error("WebSocket hatası:", error);
            showLoginError("Sunucu bağlantı hatası. Lütfen daha sonra tekrar deneyin.");
            hideLoading();
        };

        socket.onclose = () => {
            console.log("WebSocket bağlantısı kapandı.");
            showLoginError("Sunucu bağlantısı kesildi. Yeniden bağlanmak için sayfayı yenileyin.");
            appContainer.classList.add('hidden');
            orderPageContainer.classList.remove('active'); 
            loginModal.classList.add('active'); 
            hideLoading();
        };
    }

    function sendMessageToServer(type, payload) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = JSON.stringify({ type, payload });
            socket.send(message);
            console.log("Sunucuya gönderildi:", message);
        } else {
            console.error("WebSocket bağlantısı açık değil.");
            if(appState.user && (!socket || socket.readyState === WebSocket.CLOSED)){
                 console.log("Bağlantı kapalı, yeniden bağlanılıyor...");
                 setTimeout(() => connectWebSocket(), 1000); 
            } else if (!appState.user) {
                 loginModal.classList.add('active');
                 appContainer.classList.add('hidden');
                 orderPageContainer.classList.remove('active');
                 showLoginError("Lütfen önce giriş yapın.");
            }
             else {
                showLoginError("Sunucuya mesaj gönderilemedi. Bağlantı sorunu.");
            }
        }
    }

    function handleServerMessage(message) {
        hideLoading(); 
        switch (message.type) {
            case 'login_success':
                console.log("LOGIN_SUCCESS işleniyor. Payload:", message.payload);
                const userDataFromServer = message.payload.user || message.payload.waiter; 
                if (message.payload && typeof message.payload === 'object' && userDataFromServer && typeof userDataFromServer === 'object') {
                    appState.user = userDataFromServer; 
                    appState.tables = message.payload.tables || []; 
                    if (appState.user && typeof appState.user.username !== 'undefined' && typeof appState.user.role !== 'undefined') {
                        localStorage.setItem('adisyonUser', JSON.stringify(appState.user)); 

                        activeUserNameSpan.textContent = appState.user.username;
                        activeUserRoleSpan.textContent = appState.user.role;
                        loginModal.classList.remove('active');
                        appContainer.classList.remove('hidden');
                        orderPageContainer.classList.remove('active');
                        loginError.textContent = '';
                        renderInitialData(); 
                        updateUIForRole();
                        console.log("Giriş başarılı ve kaydedildi:", appState.user.username, "Rol:", appState.user.role);
                    } else {
                        console.error("Login success, ancak kullanıcı verisi (username/role) eksik/hatalı.", "appState.user:", appState.user);
                        showLoginError("Giriş bilgileri eksik (kod: CL01_V7).");
                        appState.user = null; 
                        localStorage.removeItem('adisyonUser'); 
                        loginModal.classList.add('active');
                        appContainer.classList.add('hidden');
                        orderPageContainer.classList.remove('active');
                    }
                } else {
                    console.error("Login success mesajı alındı, ancak payload veya kullanıcı verisi (user/waiter) hatalı/eksik.", "Payload:", message.payload);
                    showLoginError("Sunucudan geçersiz giriş yanıtı (kod: CL02_V7).");
                    appState.user = null;
                    localStorage.removeItem('adisyonUser'); 
                    loginModal.classList.add('active');
                    appContainer.classList.add('hidden');
                    orderPageContainer.classList.remove('active');
                }
                break;
            case 'login_fail':
                showLoginError(message.payload.error || "Kullanıcı adı veya şifre hatalı.");
                localStorage.removeItem('adisyonUser'); 
                break;
            case 'tables_update':
                if(appState.user){ 
                    console.log("[tables_update] Mesaj alındı ve işleniyor. appState.user:", appState.user); 
                    appState.tables = message.payload.tables;
                    renderTables(); 
                    renderInitialDataIfNeeded(); 
                    
                    if (orderPageContainer.classList.contains('active') && appState.currentTableId) {
                        const updatedTable = appState.tables.find(t => t.id === appState.currentTableId);
                        if (updatedTable) {
                            renderOrderPageForTable(updatedTable); 
                        } else { 
                            console.log(`Güncellenen masa (${appState.currentTableId}) bulunamadı, masalar ekranına dönülüyor.`);
                            showTablesView();
                        }
                    }
                } else {
                    console.log("[tables_update] Kullanıcı bilgisi (appState.user) henüz set edilmemiş, tables_update işlenmedi.");
                }
                break;
            case 'sales_report_data':
                appState.salesReport = message.payload.sales || [];
                renderSalesReport();
                break;
            case 'order_update_fail':
                alert(`Sipariş güncellenemedi: ${message.payload.error}`);
                break;
             case 'manual_order_update_fail': 
                alert(`Manuel ürün eklenemedi: ${message.payload.error}`);
                break;
            case 'quick_sale_success': 
                console.log("Hızlı satış sunucuda tamamlandı.");
                appState.currentQuickSaleOrder = [];
                renderQuickSaleOrder();
                break;
            case 'quick_sale_fail':
                alert(`Hızlı satış tamamlanamadı: ${message.payload.error}`);
                break;
            case 'error':
                alert(`Sunucu Hatası: ${message.payload.message}`);
                break;
            default:
                console.warn("Bilinmeyen mesaj tipi:", message.type, "Payload:", message.payload);
        }
    }
    
    function showLoginError(message) {
        loginError.textContent = message;
        passwordInput.value = ''; 
    }

    // --- Rol Bazlı UI Güncelleme ---
    function updateUIForRole() {
        if (!appState.user) return;
        console.log("UI güncelleniyor. Kullanıcı rolü:", appState.user.role);
        
        if (appState.user.role === 'cashier') {
            manualProductSection.classList.remove('hidden');
            salesReportButton.classList.remove('hidden'); 
            quickSaleEntryButton.classList.remove('hidden'); 
        } else {
            manualProductSection.classList.add('hidden');
            salesReportButton.classList.add('hidden'); 
            quickSaleEntryButton.classList.add('hidden'); 
        }
    }
    
    // Gerekliyse başlangıç render fonksiyonlarını çağırır
    let initialDataRendered = false;
    function renderInitialDataIfNeeded() {
        if (!initialDataRendered) {
            renderProductGrid(orderPageProductGrid, false); 
            renderProductGrid(quickSaleProductGrid, true); 
            renderProductsForReference();
            populateManualCategorySelect(); 
            initialDataRendered = true;
            console.log("İlk data render edildi (ürün grid, referans, kategori select).");
        }
    }


    // --- Render Fonksiyonları ---
    function renderInitialData() {
        renderInitialDataIfNeeded(); 
    }

    function renderTables() {
        console.log("[renderTables] Fonksiyon çağrıldı. Masa sayısı:", appState.tables ? appState.tables.length : 0); 
        tablesGrid.innerHTML = '';
        if (!appState.tables || appState.tables.length === 0) {
             tablesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Masa bilgisi bekleniyor...</p>';
             return;
        }
        appState.tables.forEach(table => {
            const tableCard = document.createElement('div');
            const isDolu = table.status === 'dolu' && table.order && table.order.length > 0;
            tableCard.className = `p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200 ease-in-out transform hover:scale-105 ${isDolu ? 'bg-red-400 hover:bg-red-500' : 'bg-green-400 hover:bg-green-500'}`;
            let waiterInfoHtml = '';
            if (isDolu && table.waiterUsername) { 
                waiterInfoHtml = `<p class="text-xs text-white text-center mt-1">Garson: ${table.waiterUsername}</p>`;
            }
            tableCard.innerHTML = `
                <h3 class="text-xl font-semibold text-white text-center">${table.name}</h3>
                <p class="text-sm text-white text-center capitalize">${isDolu ? 'Dolu' : 'Boş'}</p>
                ${isDolu ? `<p class="text-xs text-white text-center mt-1">Toplam: ${formatPrice(table.total)}</p>` : ''}
                ${waiterInfoHtml}
            `;
            tableCard.addEventListener('click', () => selectTableForOrder(table.id)); 
            tablesGrid.appendChild(tableCard);
        });
    }

    // Ürün Seçim Gridini Oluşturur (Hem normal sipariş hem hızlı satış için)
    function renderProductGrid(targetGridElement = orderPageProductGrid, forQuickSale = false) {
        targetGridElement.innerHTML = ''; 
        const categories = {};
        const categorySectionColors = { 
            "ET - TAVUK": "category-section-bg-ET-TAVUK",
            "ATIŞTIRMALIK": "category-section-bg-ATIŞTIRMALIK",
            "TATLI": "category-section-bg-TATLI",
            "İÇECEK": "category-section-bg-İÇECEK",
            "ÇORBA": "category-section-bg-ÇORBA",
            "DİĞER": "category-section-bg-DİĞER",
        };
        const productCardColors = {
            "ET - TAVUK": "product-card-bg-ET-TAVUK",
            "ATIŞTIRMALIK": "product-card-bg-ATIŞTIRMALIK",
            "TATLI": "product-card-bg-TATLI",
            "İÇECEK": "product-card-bg-İÇECEK",
            "ÇORBA": "product-card-bg-ÇORBA",
            "DİĞER": "product-card-bg-DİĞER",
        };
        const defaultSectionColor = "category-section-bg-default";
        const defaultCardColor = "product-card-bg-default";


        appState.products.forEach(product => {
             const categoryKey = product.category || 'DİĞER'; 
            if (!categories[categoryKey]) {
                categories[categoryKey] = [];
            }
            categories[categoryKey].push(product);
        });
        
        const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "DİĞER"];
        const sortedCategories = Object.keys(categories).sort((a, b) => {
            const indexA = categoryOrder.indexOf(a);
            const indexB = categoryOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b, 'tr'); 
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedCategories.forEach(category => {
            const categorySection = document.createElement('div');
            const sectionBgColorClass = categorySectionColors[category] || defaultSectionColor; 
            categorySection.className = `mb-6 p-4 rounded-lg ${sectionBgColorClass}`; 
            
            const categoryTitle = document.createElement('h4');
            categoryTitle.className = 'text-lg font-semibold mb-3 text-gray-700 border-b border-gray-400 pb-1'; 
            categoryTitle.textContent = category;
            categorySection.appendChild(categoryTitle);

            const productGrid = document.createElement('div');
            // **DEĞİŞİKLİK:** Hızlı satış için 5 sütun (sm ve üzeri), normal sipariş için mobil 2, tablet+ 3 sütun
            productGrid.className = forQuickSale ? 'grid grid-cols-3 sm:grid-cols-5 gap-2' : 'grid grid-cols-2 md:grid-cols-3 gap-3'; 

            categories[category].sort((a, b) => a.name.localeCompare(b, 'tr')).forEach(product => {
                const card = document.createElement('div');
                const cardBgColorClass = productCardColors[category] || defaultCardColor; 
                card.className = `product-card ${cardBgColorClass} ${forQuickSale ? 'quick-sale-card' : ''}`; 
                card.dataset.productId = product.id; 

                if (forQuickSale) {
                    card.innerHTML = `
                        <h5 class="font-semibold text-gray-800 text-center">${product.name}</h5>
                        <div class="product-card-quantity flex items-center justify-center space-x-1 my-1">
                            <button class="quantity-decrease bg-red-200 hover:bg-red-300 text-red-700 font-bold rounded text-xs">-</button>
                            <input type="number" value="1" min="1" class="quantity-input border border-gray-300 rounded text-xs p-1">
                            <button class="quantity-increase bg-green-200 hover:bg-green-300 text-green-700 font-bold rounded text-xs">+</button>
                        </div>
                        <button data-for-quick-sale="true" class="add-item-from-card-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1.5 px-2 rounded w-full mt-1">Ekle</button>
                    `;
                } else {
                    card.innerHTML = `
                        <div>
                            <h5 class="font-semibold text-sm text-gray-800">${product.name}</h5>
                            <p class="product-price text-xs text-gray-600">${formatPrice(product.price)}</p>
                        </div>
                        <div class="mt-2">
                            <input type="text" placeholder="Açıklama..." class="description-input border border-gray-300 rounded text-xs p-1 w-full mb-2">
                            <div class="product-card-quantity flex items-center justify-center space-x-1">
                                <button class="quantity-decrease bg-red-200 hover:bg-red-300 text-red-700 font-bold rounded">-</button>
                                <input type="number" value="1" min="1" class="quantity-input border border-gray-300 rounded text-xs p-1">
                                <button class="quantity-increase bg-green-200 hover:bg-green-300 text-green-700 font-bold rounded">+</button>
                            </div>
                        </div>
                        <button data-for-quick-sale="false" class="add-item-from-card-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-2 rounded w-full mt-2">Ekle</button>
                    `;
                }
                productGrid.appendChild(card);
            });

            categorySection.appendChild(productGrid);
            targetGridElement.appendChild(categorySection);
        });
        addProductCardEventListeners(forQuickSale); 
    }

    // Ürün kartlarındaki butonlara event listener ekler
    function addProductCardEventListeners(forQuickSale = false) {
        const selector = forQuickSale ? '#quickSaleProductGrid .product-card' : '#orderPageProductGrid .product-card';
        document.querySelectorAll(selector).forEach(card => {
            const quantityInput = card.querySelector('.quantity-input');
            const decreaseBtn = card.querySelector('.quantity-decrease');
            const increaseBtn = card.querySelector('.quantity-increase');
            const addBtn = card.querySelector('.add-item-from-card-btn');
            const descriptionInput = forQuickSale ? null : card.querySelector('.description-input'); 
            const productId = card.dataset.productId;

            decreaseBtn.addEventListener('click', () => {
                let currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity > 1) {
                    quantityInput.value = currentQuantity - 1;
                }
            });

            increaseBtn.addEventListener('click', () => {
                quantityInput.value = parseInt(quantityInput.value) + 1;
            });

            addBtn.addEventListener('click', () => {
                const descValue = forQuickSale ? '' : (descriptionInput ? descriptionInput.value.trim() : '');
                if (forQuickSale) {
                    addProductToQuickSale(productId, parseInt(quantityInput.value), descValue);
                } else {
                    addProductFromCard(productId, parseInt(quantityInput.value), descValue);
                }
                quantityInput.value = 1;
                if (descriptionInput) descriptionInput.value = '';
            });
        });
    }
    
    // Ürün kartından normal sipariş ekleme fonksiyonu
    function addProductFromCard(productId, quantity, description) {
         const product = appState.products.find(p => p.id === parseInt(productId));
         if (!product || quantity <= 0 || !appState.currentTableId) {
            alert("Ürün eklenirken bir hata oluştu.");
            return;
        }
        showLoading("Sipariş ekleniyor...");
        sendMessageToServer('add_order_item', {
            tableId: appState.currentTableId,
            productId: parseInt(productId),
            quantity: quantity,
            description: description 
        });
    }
    
    // Hızlı satış sepetine ürün ekleme
    function addProductToQuickSale(productId, quantity, description) {
        const product = appState.products.find(p => p.id === parseInt(productId));
        if (!product || quantity <= 0) {
            alert("Ürün eklenirken bir hata oluştu.");
            return;
        }
        const existingItem = appState.currentQuickSaleOrder.find(item => 
            item.productId === parseInt(productId) && 
            item.description === description 
        );
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            appState.currentQuickSaleOrder.push({
                productId: parseInt(productId),
                name: product.name, 
                priceAtOrder: product.price,
                quantity: quantity,
                description: description, 
                waiterUsername: appState.user.username, 
                timestamp: Date.now()
            });
        }
        renderQuickSaleOrder();
    }

    // Hızlı satış sepetini render eder
    function renderQuickSaleOrder() {
        quickSaleCurrentItems.innerHTML = '';
        let total = 0;
        if (appState.currentQuickSaleOrder.length === 0) {
            quickSaleCurrentItems.innerHTML = '<p class="text-gray-500 text-center py-4">Sepet boş.</p>';
            quickSaleTotal.textContent = 'Toplam: 0 ₺';
            return;
        }
        appState.currentQuickSaleOrder.forEach((item, index) => {
            const itemTotal = item.priceAtOrder * item.quantity;
            total += itemTotal;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-start p-2 bg-white rounded-md text-sm';
            let descriptionHTML = item.description ? `<p class="text-xs text-gray-500"><em>${item.description}</em></p>` : '';
            itemDiv.innerHTML = `
                <div>
                    <span class="font-medium">${item.name}</span>
                    <span class="text-xs text-gray-500"> (${item.quantity} x ${formatPrice(item.priceAtOrder)})</span>
                    ${descriptionHTML}
                </div>
                <div class="flex items-center">
                    <span class="font-semibold mr-2">${formatPrice(itemTotal)}</span>
                    <button data-index="${index}" class="remove-item-quick-sale-btn text-red-500 hover:text-red-700 text-xs p-1">X</button>
                </div>
            `;
            quickSaleCurrentItems.appendChild(itemDiv);
        });
        quickSaleTotal.textContent = `Toplam: ${formatPrice(total)}`;

        document.querySelectorAll('.remove-item-quick-sale-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const itemIndex = parseInt(e.target.dataset.index);
                appState.currentQuickSaleOrder.splice(itemIndex, 1);
                renderQuickSaleOrder();
            });
        });
    }


    // Manuel ürün ekleme için kategori seçeneklerini doldurur
    function populateManualCategorySelect() {
        manualProductCategory.innerHTML = '<option value="">Kategori Seçin</option>'; 
        const categories = ["ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "ÇORBA", "DİĞER"]; 
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            manualProductCategory.appendChild(option);
        });
    }


    function renderProductsForReference() {
        productsListRef.innerHTML = '';
        const categories = {};
        appState.products.forEach(product => {
             const categoryKey = product.category || 'DİĞER'; 
            if (!categories[categoryKey]) categories[categoryKey] = [];
            categories[categoryKey].push(product);
        });

        const categoryOrder = ["ÇORBA", "ET - TAVUK", "ATIŞTIRMALIK", "İÇECEK", "TATLI", "DİĞER"];
        const sortedCategories = Object.keys(categories).sort((a, b) => {
            const indexA = categoryOrder.indexOf(a);
            const indexB = categoryOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b, 'tr'); 
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedCategories.forEach(category => {
            const categoryTitle = document.createElement('h3');
            categoryTitle.className = 'text-lg font-semibold mt-4 mb-2 text-blue-700';
            categoryTitle.textContent = category;
            productsListRef.appendChild(categoryTitle);
            const ul = document.createElement('ul');
            ul.className = 'space-y-1';
            categories[category].sort((a,b) => a.name.localeCompare(b, 'tr')).forEach(product => {
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-800 flex justify-between';
                li.innerHTML = `<span>${product.name}</span> <span class="font-medium">${formatPrice(product.price)}</span>`;
                ul.appendChild(li);
            });
            productsListRef.appendChild(ul);
        });
    }
    
    // Sipariş sayfasındaki mevcut siparişleri render eder
    function renderOrderPageForTable(table) { 
        orderPageCurrentOrderItems.innerHTML = '';
        
        if (table.status === 'dolu' && table.waiterUsername) {
            orderPageWaiterInfo.textContent = `Bu Siparişi Alan Garson: ${table.waiterUsername}`;
        } else if (table.status === 'dolu' && !table.waiterUsername && appState.user && appState.user.role === 'cashier') {
             orderPageWaiterInfo.textContent = `Sipariş Alındı (Garson Belirsiz)`;
        }
         else {
            orderPageWaiterInfo.textContent = 'Bu Masaya Henüz Sipariş Alınmadı';
        }

        if (!table || !table.order || table.order.length === 0) {
            orderPageCurrentOrderItems.innerHTML = '<p class="text-gray-500 py-4">Sipariş boş.</p>';
            orderPageCurrentOrderTotal.textContent = 'Toplam: 0 ₺';
        } else {
            table.order.forEach((item) => {
                const orderItemDiv = document.createElement('div');
                orderItemDiv.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-md';
                
                let itemName = item.name || 'Bilinmeyen Ürün'; 
                let itemPrice = item.priceAtOrder || 0; 
                const productDetails = appState.products.find(p => p.id === item.productId); 
                if(productDetails && !item.name) { 
                    itemName = productDetails.name;
                }
                
                let descriptionHTML = '';
                if (item.description && item.description.trim() !== '') {
                    descriptionHTML = `<p class="text-xs text-gray-500 pl-1 mt-1"><em>Açıklama: ${item.description}</em></p>`;
                }
                
                let waiterNameHTML = '';
                 if (item.waiterUsername) {
                     waiterNameHTML = `<p class="text-xs text-blue-500 pl-1 mt-1">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</p>`; 
                 }


                orderItemDiv.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium">${itemName}</span>
                        <span class="text-sm text-gray-600"> (${item.quantity} x ${formatPrice(itemPrice)})</span>
                        ${descriptionHTML}
                        ${waiterNameHTML} 
                    </div>
                    <div class="flex items-center ml-2">
                        <span class="font-semibold mr-3">${formatPrice(item.quantity * itemPrice)}</span>
                        <button data-product-id="${item.productId || 'manual'}" data-item-name="${itemName}" data-item-description="${item.description || ''}" class="remove-item-btn-orderpage text-red-500 hover:text-red-700 text-sm font-bold p-1 rounded-full bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-400">X</button>
                    </div>
                `;
                orderPageCurrentOrderItems.appendChild(orderItemDiv);
            });
            orderPageCurrentOrderTotal.textContent = `Toplam: ${formatPrice(table.total)}`;
        }
        
        if (appState.user && appState.user.role === 'cashier') {
            orderPageCompleteOrderButton.classList.remove('hidden');
        } else {
            orderPageCompleteOrderButton.classList.add('hidden');
        }

        document.querySelectorAll('.remove-item-btn-orderpage').forEach(button => {
            button.addEventListener('click', (e) => {
                const buttonElement = e.target.closest('button');
                const productIdToRemove = buttonElement.dataset.productId; 
                const descriptionToRemove = buttonElement.dataset.description; 
                const nameToRemove = buttonElement.dataset.itemName; 
                removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove); 
            });
        });
    }

    // Satış Raporu Modalı'nı render eder
    function renderSalesReport() {
        salesReportTableContainer.innerHTML = ''; 
        let totalItems = 0;
        let grandTotal = 0;

        if (!appState.salesReport || appState.salesReport.length === 0) {
            salesReportTableContainer.innerHTML = '<p class="text-center text-gray-500 py-6">Henüz tamamlanmış satış yok.</p>';
            totalItemsSoldSpan.textContent = '0';
            grandTotalSalesSpan.textContent = formatPrice(0);
            return;
        }

        const table = document.createElement('table');
        table.className = 'w-full text-sm border-collapse border border-gray-300';
        table.innerHTML = `
            <thead class="bg-gray-100">
                <tr>
                    <th class="border p-2">Kapanış Zamanı</th>
                    <th class="border p-2">Masa/Satış Tipi</th>
                    <th class="border p-2">Ürün</th>
                    <th class="border p-2 text-center">Adet</th>
                    <th class="border p-2 text-right">Birim Fiyat</th>
                    <th class="border p-2 text-right">Toplam</th>
                    <th class="border p-2">Garson/Kasa</th>
                    <th class="border p-2">Açıklama</th>
                    <th class="border p-2">Ekleme Zamanı</th> 
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        const tbody = table.querySelector('tbody');

        appState.salesReport.sort((a, b) => (b.closingTimestamp || 0) - (a.closingTimestamp || 0)); 

        appState.salesReport.forEach(item => {
            const itemTotal = (item.priceAtOrder || 0) * item.quantity;
            totalItems += item.quantity;
            grandTotal += itemTotal;
            
            let itemName = item.name || (appState.products.find(p=>p.id === item.productId)?.name || 'Bilinmeyen');

            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.innerHTML = `
                <td class="border p-2 whitespace-nowrap">${formatTimestamp(item.closingTimestamp)}</td>
                <td class="border p-2">${item.tableName || 'Hızlı Satış'}</td>
                <td class="border p-2">${itemName}</td>
                <td class="border p-2 text-center">${item.quantity}</td>
                <td class="border p-2 text-right">${formatPrice(item.priceAtOrder || 0)}</td>
                <td class="border p-2 text-right">${formatPrice(itemTotal)}</td>
                <td class="border p-2">${item.waiterUsername || '-'}</td>
                <td class="border p-2">${item.description || '-'}</td>
                <td class="border p-2 whitespace-nowrap">${formatTimestamp(item.timestamp)}</td> 
            `;
            tbody.appendChild(tr);
        });

        salesReportTableContainer.appendChild(table);
        totalItemsSoldSpan.textContent = totalItems;
        grandTotalSalesSpan.textContent = formatPrice(grandTotal);
    }


    // --- İşlevler ---
    function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        if (!username || !password) {
            showLoginError("Kullanıcı adı ve şifre boş bırakılamaz.");
            return;
        }
        loginError.textContent = ''; 
        showLoading("Giriş yapılıyor...");
        sendMessageToServer('login', { username, password });
    }
    
    function handleLogout() {
        localStorage.removeItem('adisyonUser'); 
        sendMessageToServer('logout', {});
        appState.user = null;
        appState.tables = [];
        loginModal.classList.add('active');
        appContainer.classList.add('hidden');
        orderPageContainer.classList.remove('active'); 
        quickSaleModal.classList.remove('active'); 
        usernameInput.value = '';
        passwordInput.value = '';
        console.log("Çıkış yapıldı ve oturum temizlendi.");
        initialDataRendered = false; 
    }

    function showTablesView() {
        appContainer.classList.remove('hidden');
        orderPageContainer.classList.remove('active');
        quickSaleModal.classList.remove('active'); 
        appState.currentTableId = null;
    }

    function selectTableForOrder(tableId) {
        appState.currentTableId = tableId;
        const table = appState.tables.find(t => t.id === tableId);
        if (table) {
            orderPageTableName.textContent = table.name;
            renderOrderPageForTable(table); 
            updateUIForRole(); 
            appContainer.classList.add('hidden'); 
            orderPageContainer.classList.add('active'); 
        } else {
            console.error("Seçilen masa bulunamadı:", tableId);
            showTablesView(); 
        }
    }

    // Manuel ürün ekleme fonksiyonu
    function addManualProduct() {
        const name = manualProductName.value.trim();
        const category = manualProductCategory.value; 
        const price = parseFloat(manualProductPrice.value);
        const quantity = parseInt(manualProductQuantity.value);
        const description = manualProductDescription.value.trim();

        if (!name || !category || isNaN(price) || price < 0 || isNaN(quantity) || quantity <= 0 || !appState.currentTableId) {
             alert("Lütfen geçerli bir ürün adı, kategori, fiyat ve adet girin.");
            return;
        }

        if (appState.user && appState.user.role !== 'cashier') {
            alert("Manuel ürün ekleme yetkiniz yok.");
            return;
        }
        
        showLoading("Manuel ürün ekleniyor...");
        sendMessageToServer('add_manual_order_item', { 
            tableId: appState.currentTableId,
            name: name,
            category: category, 
            price: price,
            quantity: quantity,
            description: description
        });

        manualProductName.value = '';
        manualProductCategory.value = ''; 
        manualProductPrice.value = '';
        manualProductQuantity.value = '1';
        manualProductDescription.value = '';
    }


    // Ürün silme fonksiyonu güncellendi
    function removeItemFromOrderPage(productIdToRemove, descriptionToRemove, nameToRemove) {
         if (!appState.currentTableId) return;
        showLoading("Ürün siliniyor...");
        sendMessageToServer('remove_order_item', {
            tableId: appState.currentTableId,
            productId: productIdToRemove === 'manual' ? null : parseInt(productIdToRemove), 
            name: productIdToRemove === 'manual' ? nameToRemove : null, 
            description: descriptionToRemove 
        });
    }

    function completeOrderAndShowReceiptOnPage() {
        const table = appState.tables.find(t => t.id === appState.currentTableId);
        if (!table || !table.order || table.order.length === 0) {
            alert("Masada tamamlanacak sipariş bulunmuyor.");
            return;
        }
        prepareAndShowReceipt(table.order, table.name, table.waiterUsername, table.total);
    }
    
    // Hızlı Satış Modalını Açma
    function openQuickSaleModal() {
        if (appState.user && appState.user.role === 'cashier') {
            appState.currentQuickSaleOrder = []; 
            renderQuickSaleOrder(); 
            renderProductGrid(quickSaleProductGrid, true); 
            quickSaleModal.classList.add('active');
            appContainer.classList.add('hidden'); 
            orderPageContainer.classList.remove('active'); 
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }

    // Hızlı Satışı Tamamlama
    function completeQuickSale() {
        if (appState.currentQuickSaleOrder.length === 0) {
            alert("Hızlı satış sepeti boş.");
            return;
        }
        showLoading("Hızlı satış tamamlanıyor...");
        sendMessageToServer('complete_quick_sale', { 
            items: appState.currentQuickSaleOrder,
            cashierUsername: appState.user.username 
        });
        const quickSaleTotalAmount = appState.currentQuickSaleOrder.reduce((sum, item) => sum + (item.priceAtOrder * item.quantity), 0);
        prepareAndShowReceipt(appState.currentQuickSaleOrder, "Hızlı Satış", appState.user.username, quickSaleTotalAmount);
        quickSaleModal.classList.remove('active'); 
        showTablesView(); 
    }


    // Ortak fiş hazırlama fonksiyonu
    function prepareAndShowReceipt(orderItems, tableName, waiterName, totalAmount) {
        receiptDate.textContent = getCurrentFormattedDate();
        receiptTableName.textContent = tableName;
        
        if (waiterName) {
            receiptWaiterName.textContent = waiterName;
        } else if (appState.user && appState.user.username) { 
            receiptWaiterName.textContent = appState.user.username; 
        } else {
            receiptWaiterName.textContent = "Bilinmiyor";
        }
        
        receiptItems.innerHTML = '';

        orderItems.forEach(item => {
            let itemName = item.name || 'Bilinmeyen Ürün'; 
            let itemPrice = item.priceAtOrder || 0; 
            const productDetails = appState.products.find(p => p.id === item.productId); 
            if(productDetails && !item.name) { 
                itemName = productDetails.name;
            }
            
            let descriptionHTML = '';
            if (item.description && item.description.trim() !== '') {
                descriptionHTML = `<span class="item-description">(${item.description})</span>`;
            }
            
            let itemWaiterHTML = ''; 
            if (item.waiterUsername && tableName !== "Hızlı Satış") { 
                 itemWaiterHTML = `<span class="item-waiter">Ekleyen: ${item.waiterUsername} (${formatTimestamp(item.timestamp)})</span>`; 
            }

            const itemDiv = document.createElement('div');
            itemDiv.innerHTML = `
                <span class="item-details">${item.quantity}x ${itemName} ${descriptionHTML} ${itemWaiterHTML}</span>
                <span class="item-price">${formatPrice(item.quantity * itemPrice)}</span>`;
            receiptItems.appendChild(itemDiv);
        });
        receiptTotal.textContent = formatPrice(totalAmount);

        receiptModal.classList.add('active');
    }

    
    function handlePrintReceipt() {
        window.print();
    }

    // Satış raporu modalını açar ve veri ister
    function openSalesReport() {
        if (appState.user && appState.user.role === 'cashier') {
            showLoading("Satış raporu yükleniyor...");
            sendMessageToServer('get_sales_report', {}); 
            salesReportModal.classList.add('active');
        } else {
            alert("Bu özelliği kullanma yetkiniz yok.");
        }
    }

    // Satış raporunu yazdırır
    function printSalesReport() {
        window.print(); 
    }


    function closeReceiptAndResetTable() {
        // Sadece normal masa siparişinden geliyorsa ve kasaysa masayı kapat
        if (appState.currentTableId && appState.user && appState.user.role === 'cashier') {
            showLoading("Masa kapatılıyor...");
            sendMessageToServer('close_table', { tableId: appState.currentTableId }); 
        } else if (appState.user && appState.user.role !== 'cashier' && appState.currentTableId) {
             console.log("Garson fiş modalını kapattı, masa açık kalacak.");
        }
        receiptModal.classList.remove('active');
        if (appState.currentTableId && !(appState.user && appState.user.role === 'cashier')) {
            showTablesView();
        } else {
            showTablesView(); 
        }
    }

    // --- Event Listeners ---
    loginButton.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') handleLogin();
    });
    logoutButton.addEventListener('click', handleLogout);
    salesReportButton.addEventListener('click', openSalesReport); 
    quickSaleEntryButton.addEventListener('click', openQuickSaleModal); 
    closeQuickSaleModalButton.addEventListener('click', () => { 
        quickSaleModal.classList.remove('active');
        showTablesView(); 
    });
    completeQuickSaleButton.addEventListener('click', completeQuickSale); 

    backToTablesButton.addEventListener('click', showTablesView);
    addManualProductButton.addEventListener('click', addManualProduct); 
    orderPageCompleteOrderButton.addEventListener('click', completeOrderAndShowReceiptOnPage);
    printReceiptButton.addEventListener('click', handlePrintReceipt);
    closeReceiptModalButton.addEventListener('click', closeReceiptAndResetTable);
    closeSalesReportModalButton.addEventListener('click', () => salesReportModal.classList.remove('active')); 
    refreshSalesReportButton.addEventListener('click', () => { 
        showLoading("Rapor güncelleniyor...");
        sendMessageToServer('get_sales_report', {});
    });
    printSalesReportButton.addEventListener('click', printSalesReport); 


    // Başlangıç
    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket(); 
    });

</script>
</body>
</html>
